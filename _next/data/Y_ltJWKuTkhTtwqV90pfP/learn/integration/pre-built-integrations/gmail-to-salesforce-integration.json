{"pageProps":{"samples":{"code":"<pre class=\"shiki github-light\" style=\"background-color: #fff\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/log;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerinax/googleapis.gmail </span><span style=\"color: #D73A49\">as</span><span style=\"color: #24292E\"> gmail;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/mime;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerinax/salesforce </span><span style=\"color: #D73A49\">as</span><span style=\"color: #24292E\"> sfdc;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerina/lang.runtime;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">import</span><span style=\"color: #24292E\"> ballerinax/openai.chat </span><span style=\"color: #D73A49\">as</span><span style=\"color: #24292E\"> openAI;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Email</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> &#39;from;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> subject;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> body;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Name</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> firstName__c;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> lastName__c;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">type</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">Lead</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">record</span><span style=\"color: #24292E\"> {</span><span style=\"color: #D73A49\">|</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\">Name;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> email__c;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> phoneNumber__c;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> company__c;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> designation__c;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">|</span><span style=\"color: #24292E\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> gmailAccessToken </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> openAIKey </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> salesforceBaseUrl </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">configurable</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> salesforceAccessToken </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">?</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">final</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> label </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;Lead&quot;</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">public</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">main</span><span style=\"color: #24292E\">() </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error?</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">while</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">true</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Email[] emails </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getEmails</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">label</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Lead[] leads </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> Email email </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> emails</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">do</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            Lead</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> lead </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">generateLead</span><span style=\"color: #24292E\">(email.&#39;from, email.subject, email.body);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> lead </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> Lead {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                leads.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">lead</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">addLeadsToSalesforce</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">leads</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">        runtime</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">sleep</span><span style=\"color: #24292E\">(</span><span style=\"color: #005CC5\">600</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getEmails</span><span style=\"color: #24292E\">(</span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">label</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> Email[]</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client gmailClient </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> ({auth</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> {token: gmailAccessToken}});</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] labelIdsToMatch </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getLabelIds</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmailClient</span><span style=\"color: #24292E\">, [label]);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> (labelIdsToMatch.</span><span style=\"color: #6F42C1\">length</span><span style=\"color: #24292E\">() </span><span style=\"color: #D73A49\">==</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">0</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> e </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Unable to find any labels to match.&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> e;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread[] matchingMailThreads </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getMatchingMailThreads</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmailClient</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">labelIdsToMatch</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #6F42C1\">removeLabels</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmailClient</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">matchingMailThreads</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">labelIdsToMatch</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Message[] matchingEmails </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getMatchingEmails</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmailClient</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">matchingMailThreads</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    Email[] emails </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Message message </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> matchingEmails</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">do</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        Email</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">parseEmail</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">message</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> Email {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            emails.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">email</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }    </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> emails;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getLabelIds</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client gmailClient, </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] </span><span style=\"color: #E36209\">labelsToMatch</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[]</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">LabelList labelList </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> gmailClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">listLabels</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;me&quot;</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Label label </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> labelList.labels</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">where</span><span style=\"color: #24292E\"> labelsToMatch.</span><span style=\"color: #6F42C1\">indexOf</span><span style=\"color: #24292E\">(label.name) </span><span style=\"color: #D73A49\">!=</span><span style=\"color: #24292E\"> ()</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">select</span><span style=\"color: #24292E\"> label.id;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getMatchingMailThreads</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client gmailClient, </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] </span><span style=\"color: #E36209\">labelIdsToMatch</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread[]</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MsgSearchFilter searchFilter </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        includeSpamTrash</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">false</span><span style=\"color: #24292E\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        labelIds</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> labelIdsToMatch</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">stream&lt;</span><span style=\"color: #24292E\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread, </span><span style=\"color: #D73A49\">error?&gt;|error</span><span style=\"color: #24292E\"> mailThreadStream </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> gmailClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">listThreads</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">filter</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> searchFilter);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> mailThreadStream </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> mailThreadStream;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread mailThread </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> mailThreadStream</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">select</span><span style=\"color: #24292E\"> mailThread;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">removeLabels</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client gmailClient, </span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread[] mailThreads, </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">[] </span><span style=\"color: #E36209\">labelIds</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread mailThread </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> mailThreads</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">do</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> removeLabelResponse </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> gmailClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">modifyThread</span><span style=\"color: #24292E\">(mailThread.id, [], </span><span style=\"color: #E36209\">labelIds</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> removeLabelResponse </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            log</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">printError</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;An error occured in removing the labels from the thread.&quot;</span><span style=\"color: #24292E\">, </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #E36209\">removeLabelResponse</span><span style=\"color: #24292E\">, removeLabelResponse.</span><span style=\"color: #6F42C1\">stackTrace</span><span style=\"color: #24292E\">(), </span><span style=\"color: #E36209\">threadId</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> mailThread.id, </span><span style=\"color: #E36209\">labelIds</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> labelIds);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">getMatchingEmails</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client gmailClient, </span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread[] mailThreads) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Message[] {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Message[] messages </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> [];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    _ </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread mailThread </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> mailThreads</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">do</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MailThread</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> response </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> gmailClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">readThread</span><span style=\"color: #24292E\">(mailThread.id);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> response </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                log</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">printError</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;An error occured while reading the email.&quot;</span><span style=\"color: #24292E\">, </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #E36209\">response</span><span style=\"color: #24292E\">, response.</span><span style=\"color: #6F42C1\">stackTrace</span><span style=\"color: #24292E\">(), </span><span style=\"color: #E36209\">threadId</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> mailThread.id);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            } </span><span style=\"color: #D73A49\">else</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                messages.</span><span style=\"color: #6F42C1\">push</span><span style=\"color: #24292E\">((</span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Message[]</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">response.messages)[</span><span style=\"color: #005CC5\">0</span><span style=\"color: #24292E\">]);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> messages;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">parseEmail</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Message message) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> Email</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> &#39;from </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">message.headerFrom;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> subject </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">message.headerSubject;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> body </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">mime</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">base64Decode</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #E36209\">gmail</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">MessageBodyPart</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">message.emailBodyInText).data));</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        &#39;from</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> &#39;from,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        subject</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> subject,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        body</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> body</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">generateLead</span><span style=\"color: #24292E\">(</span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> &#39;from, </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">subject</span><span style=\"color: #24292E\">, </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #E36209\">body</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> Lead</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    openAI</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client openAIClient </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> ({</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        auth</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> {token: openAIKey}</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    openAI</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">CreateChatCompletionRequest request </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        model</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">&quot;gpt-3.5-turbo&quot;</span><span style=\"color: #24292E\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        messages</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> [</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #6F42C1\">role</span><span style=\"color: #24292E\">: </span><span style=\"color: #032F62\">&quot;user&quot;</span><span style=\"color: #24292E\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #6F42C1\">content</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> `</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            Extract the following details in JSON from the email.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #6F42C1\">firstName__c</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">, </span><span style=\"color: #6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #6F42C1\">lastName__c</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">, </span><span style=\"color: #6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #6F42C1\">email__c</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #6F42C1\">phoneNumber__c</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">, </span><span style=\"color: #6A737D\">// With country code. Use N/A if unable to find</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #6F42C1\">company__c</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\">, </span><span style=\"color: #6A737D\">// Mandatory</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                    </span><span style=\"color: #6F42C1\">designation__c</span><span style=\"color: #24292E\">: </span><span style=\"color: #005CC5\">string</span><span style=\"color: #24292E\"> </span><span style=\"color: #6A737D\">// Not mandator. Use N/A if unable to find</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">            Here is the </span><span style=\"color: #6F42C1\">email</span><span style=\"color: #24292E\">:    </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #6F42C1\">from</span><span style=\"color: #24292E\">: ${&#39;from},</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #6F42C1\">subject</span><span style=\"color: #24292E\">: ${subject},</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #6F42C1\">body</span><span style=\"color: #24292E\">: ${body}</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        `</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        ]</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    openAI</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">CreateChatCompletionResponse response </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> openAIClient</span><span style=\"color: #D73A49\">-&gt;/</span><span style=\"color: #24292E\">chat</span><span style=\"color: #D73A49\">/</span><span style=\"color: #24292E\">completions.</span><span style=\"color: #6F42C1\">post</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">request</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    Lead result </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> (</span><span style=\"color: #D73A49\">&lt;</span><span style=\"color: #005CC5\">string</span><span style=\"color: #D73A49\">&gt;</span><span style=\"color: #24292E\">response.choices[</span><span style=\"color: #005CC5\">0</span><span style=\"color: #24292E\">].message?.content).</span><span style=\"color: #6F42C1\">fromJsonStringWithType</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">Lead</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">return</span><span style=\"color: #24292E\"> result;</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">addLeadsToSalesforce</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">Lead</span><span style=\"color: #24292E\">[] </span><span style=\"color: #E36209\">leads</span><span style=\"color: #24292E\">) </span><span style=\"color: #D73A49\">returns</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error?</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    sfdc</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">Client sfdcClient </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> ({</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        baseUrl</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> salesforceBaseUrl,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        auth</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\"> {token: salesforceAccessToken}</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">from</span><span style=\"color: #24292E\"> Lead lead </span><span style=\"color: #D73A49\">in</span><span style=\"color: #24292E\"> leads</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #D73A49\">do</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        sfdc</span><span style=\"color: #D73A49\">:</span><span style=\"color: #24292E\">CreationResponse</span><span style=\"color: #D73A49\">|error</span><span style=\"color: #24292E\"> createResponse </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">check</span><span style=\"color: #24292E\"> sfdcClient</span><span style=\"color: #D73A49\">-&gt;</span><span style=\"color: #6F42C1\">create</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;EmailLead__c&quot;</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">lead</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        </span><span style=\"color: #D73A49\">if</span><span style=\"color: #24292E\"> createResponse </span><span style=\"color: #D73A49\">is</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">error</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            log</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">printError</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;An error occured while creating a Lead object on salesforce.&quot;</span><span style=\"color: #24292E\">, </span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                </span><span style=\"color: #E36209\">createResponse</span><span style=\"color: #24292E\">, createResponse.</span><span style=\"color: #6F42C1\">stackTrace</span><span style=\"color: #24292E\">(), </span><span style=\"color: #E36209\">lead</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> lead);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        } </span><span style=\"color: #D73A49\">else</span><span style=\"color: #24292E\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">            log</span><span style=\"color: #D73A49\">:</span><span style=\"color: #6F42C1\">printInfo</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">&quot;Lead successfully created.&quot;</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">lead</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> lead);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    };</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span></code></pre>"},"content":"\nimport ballerina/log;\nimport ballerinax/googleapis.gmail as gmail;\nimport ballerina/mime;\nimport ballerinax/salesforce as sfdc;\nimport ballerina/lang.runtime;\nimport ballerinax/openai.chat as openAI;\n\ntype Email record {|\n    string 'from;\n    string subject;\n    string body;\n|};\n\ntype Name record {|\n    string firstName__c;\n    string lastName__c;\n|};\n\ntype Lead record {|\n    *Name;\n    string email__c;\n    string phoneNumber__c;\n    string company__c;\n    string designation__c;\n|};\n\nconfigurable string gmailAccessToken = ?;\nconfigurable string openAIKey = ?;\nconfigurable string salesforceBaseUrl = ?;\nconfigurable string salesforceAccessToken = ?;\n\nfinal string label = \"Lead\";\n\npublic function main() returns error? {\n    while true {\n        Email[] emails = check getEmails(label);\n\n        Lead[] leads = [];\n        from Email email in emails\n        do {\n            Lead|error lead = generateLead(email.'from, email.subject, email.body);\n            if lead is Lead {\n                leads.push(lead);\n            }\n        };\n\n        check addLeadsToSalesforce(leads);\n\n        runtime:sleep(600);\n    }\n}\n\nfunction getEmails(string label) returns Email[]|error {\n    gmail:Client gmailClient = check new ({auth: {token: gmailAccessToken}});\n\n    string[] labelIdsToMatch = check getLabelIds(gmailClient, [label]);\n    if (labelIdsToMatch.length() == 0) {\n        error e = error(\"Unable to find any labels to match.\");\n        return e;\n    }\n\n    gmail:MailThread[] matchingMailThreads = check getMatchingMailThreads(gmailClient, labelIdsToMatch);\n    removeLabels(gmailClient, matchingMailThreads, labelIdsToMatch);\n\n    gmail:Message[] matchingEmails = getMatchingEmails(gmailClient, matchingMailThreads);\n\n    Email[] emails = [];\n    from gmail:Message message in matchingEmails\n    do {\n        Email|error email = parseEmail(message);\n        if email is Email {\n            emails.push(email);\n        }    \n    };\n    \n    return emails;\n}\n\nfunction getLabelIds(gmail:Client gmailClient, string[] labelsToMatch) returns string[]|error {\n    gmail:LabelList labelList = check gmailClient->listLabels(\"me\");\n\n    return from gmail:Label label in labelList.labels\n        where labelsToMatch.indexOf(label.name) != ()\n        select label.id;\n}\n\nfunction getMatchingMailThreads(gmail:Client gmailClient, string[] labelIdsToMatch) returns gmail:MailThread[]|error {\n    gmail:MsgSearchFilter searchFilter = {\n        includeSpamTrash: false,\n        labelIds: labelIdsToMatch\n    };\n\n    stream<gmail:MailThread, error?>|error mailThreadStream = gmailClient->listThreads(filter = searchFilter);\n    if mailThreadStream is error {\n        return mailThreadStream;\n    }\n\n    return check from gmail:MailThread mailThread in mailThreadStream\n        select mailThread;\n}\n\nfunction removeLabels(gmail:Client gmailClient, gmail:MailThread[] mailThreads, string[] labelIds) {\n    from gmail:MailThread mailThread in mailThreads\n    do {\n        gmail:MailThread|error removeLabelResponse = gmailClient->modifyThread(mailThread.id, [], labelIds);\n        if removeLabelResponse is error {\n            log:printError(\"An error occured in removing the labels from the thread.\", \n                removeLabelResponse, removeLabelResponse.stackTrace(), threadId = mailThread.id, labelIds = labelIds);\n        }\n    };\n}\n\nfunction getMatchingEmails(gmail:Client gmailClient, gmail:MailThread[] mailThreads) returns gmail:Message[] {\n    gmail:Message[] messages = [];\n    _ = from gmail:MailThread mailThread in mailThreads\n        do {\n            gmail:MailThread|error response = gmailClient->readThread(mailThread.id);\n            if response is error {\n                log:printError(\"An error occured while reading the email.\", \n                    response, response.stackTrace(), threadId = mailThread.id);\n            } else {\n                messages.push((<gmail:Message[]>response.messages)[0]);\n            }\n        };\n\n    return messages;\n}\n\nfunction parseEmail(gmail:Message message) returns Email|error {\n    string 'from = <string>message.headerFrom;\n    string subject = <string>message.headerSubject;\n    string body = <string>(check mime:base64Decode(<string>(<gmail:MessageBodyPart>message.emailBodyInText).data));\n\n    return {\n        'from: 'from,\n        subject: subject,\n        body: body\n    };\n}\n\nfunction generateLead(string 'from, string subject, string body) returns Lead|error {\n    openAI:Client openAIClient = check new ({\n        auth: {token: openAIKey}\n    });\n\n    openAI:CreateChatCompletionRequest request = {\n        model: \"gpt-3.5-turbo\",\n        messages: [\n            {\n                role: \"user\",\n                content: string `\n            Extract the following details in JSON from the email.\n                {\n                    firstName__c: string, // Mandatory\n                    lastName__c: string, // Mandatory\n                    email__c: string // Mandatory\n                    phoneNumber__c: string, // With country code. Use N/A if unable to find\n                    company__c: string, // Mandatory\n                    designation__c: string // Not mandator. Use N/A if unable to find\n                }\n\n            Here is the email:    \n            {\n                from: ${'from},\n                subject: ${subject},\n                body: ${body}\n            }\n        `\n            }\n        ]\n    };\n\n    openAI:CreateChatCompletionResponse response = check openAIClient->/chat/completions.post(request);\n\n    Lead result = check (<string>response.choices[0].message?.content).fromJsonStringWithType(Lead);\n    return result;\n}\n\nfunction addLeadsToSalesforce(Lead[] leads) returns error? {\n    sfdc:Client sfdcClient = check new ({\n        baseUrl: salesforceBaseUrl,\n        auth: {token: salesforceAccessToken}\n    });\n\n    from Lead lead in leads\n    do {\n        sfdc:CreationResponse|error createResponse = check sfdcClient->create(\"EmailLead__c\", lead);\n        if createResponse is error {\n            log:printError(\"An error occured while creating a Lead object on salesforce.\", \n                createResponse, createResponse.stackTrace(), lead = lead);\n        } else {\n            log:printInfo(\"Lead successfully created.\", lead = lead);\n        }\n    };\n}\n"},"__N_SSG":true}